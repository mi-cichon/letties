@if (gameState(); as state) {
  @if (lastError(); as error) {
    <div class="move-error-toast animate-toast">
      <div class="error-content">
        <span class="icon">‚ö†Ô∏è</span>
        <span class="message">{{ 'lobby.errors.' + error | transloco }}</span>
      </div>
      <button class="close-btn" (click)="lastError.set(null)">√ó</button>
    </div>
  }

  <div
    class="game-layout animate-in"
    [style.--grid-size]="state.layout?.width || 15"
    cdkDropListGroup
  >
    <aside class="game-sidebar">
      <div class="sidebar-header">
        <h2>{{ lobbyId() | lobbyName }}</h2>
        <div class="bag-card">
          <span class="icon">üí∞</span>
          <div class="bag-details">
            <span class="label">{{ 'lobby.bag' | transloco }}</span>
            <span class="count">{{ state.tilesRemainingInBag }}</span>
          </div>
        </div>
      </div>

      <div class="score-wrapper">
        <div class="scores-container">
          @for (score of scoresByDepleted(); track score.playerId) {
            <div
              class="player-card"
              [class.active]="score.playerId === state.currentTurnPlayerId"
              [class.depleted]="score.timeDepleted"
              [class.offline]="score.playerId! | getPlayerOffline: lobbyState()!.players!"
            >
              <div class="player-info">
                <div class="top-details">
                  <span class="name">{{ score.playerName }} </span>
                  <span class="hand-indicator">
                    @let botInfo = score.playerId! | getBotInfo: lobbyState()!.players!;
                    @if (botInfo.isBot) {
                      <span class="bot-icon" title="Bot">ü§ñ{{ botInfo.difficultyText }}</span>
                    }
                    ü§ö {{ score.tilesRemainingInHand }}</span
                  >
                </div>

                <div class="details">
                  <span class="score-val">{{ score.totalPoints }} p.</span>
                  <span class="remaining-time">
                    {{ score.playerId! | getPlayerTime: playerRemainingTimes() }}
                  </span>
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    </aside>

    <main class="board-area">
      <div class="board-wrapper">
        <div class="board-container">
          <div
            class="board"
            [style.--grid-cols]="state.layout?.width || 15"
            [style.--grid-rows]="state.layout?.height || 15"
          >
            @for (cell of state.layout!.cells; track cell.id) {
              @let placedTile = placedTilesMap().get(cell.id!);
              @let localTileId = localPlacements().get(cell.id!);

              <div
                class="cell"
                [class]="'cell-type-' + cell.type"
                cdkDropList
                [cdkDropListDisabled]="!isMyTurn()"
                [cdkDropListSortingDisabled]="true"
                [cdkDropListEnterPredicate]="canDropOnBoard"
                [cdkDropListData]="cell.id!"
                (cdkDropListDropped)="onDropToBoard($event)"
                [attr.data-cell-id]="cell.id!"
              >
                @if (!placedTile && !localTileId) {
                  <span class="cell-label">{{ cell.type! | cellLabel }}</span>
                }

                @if (placedTile || localTileId) {
                  @let vId = placedTile?.valueId || getTileValueIdFromHand(localTileId!);
                  @let def = tileDefsMap().get(vId!);

                  <div
                    class="tile"
                    [class.placed]="!!placedTile"
                    [class.local]="!!localTileId"
                    [cdkDragDisabled]="!!placedTile"
                    cdkDrag
                    [cdkDragData]="localTileId"
                  >
                    @let sel = localSelectedValues().get(cell.id!);
                    @if (sel) {
                      <span class="letter">{{ tileDefsMap().get(sel)?.valueText }}</span>
                      <span class="blank-indicator">?</span>
                    } @else if (placedTile?.selectedValueId) {
                      <span class="letter">{{
                        tileDefsMap().get(placedTile?.selectedValueId!)?.valueText
                      }}</span>
                      <span class="blank-indicator">?</span>
                    } @else {
                      <span class="letter">{{ def?.valueText }}</span>
                    }
                    <span class="points">{{ def?.basePoints }}</span>
                    <div *cdkDragPlaceholder></div>
                  </div>
                  @if (def?.valueText === '?' && activeBlankPickerCell() === cell.id!) {
                    @let boardPosition =
                      $index | boardPosition: state.layout?.width! : state.layout?.height!;

                    <div
                      class="blank-picker"
                      [class.left]="boardPosition.horizontal === 'left'"
                      [class.right]="boardPosition.horizontal === 'right'"
                      [class.top]="boardPosition.vertical === 'top'"
                      [class.bottom]="boardPosition.vertical === 'bottom'"
                    >
                      <div class="blank-grid">
                        @for (opt of blankOptions(); track opt.valueId) {
                          <button
                            class="blank-btn"
                            (click)="
                              chooseBlankValue(cell.id!, opt.valueId); $event.stopPropagation()
                            "
                          >
                            {{ opt.text }}
                          </button>
                        }
                      </div>
                      <button
                        class="blank-clear"
                        (click)="clearBlankSelection(cell.id!); $event.stopPropagation()"
                      >
                        √ó
                      </button>
                    </div>
                  }
                }
              </div>
            }
          </div>
        </div>
      </div>

      @if (amIPlaying()) {
        <footer class="hand-section">
          <div class="rack-container">
            <div
              class="player-rack"
              cdkDropList
              orientation="horizontal"
              cdkDropListOrientation="horizontal"
              [cdkDropListData]="orderedHand()"
              (cdkDropListDropped)="onDropToRack($event)"
              (cdkDropListEntered)="isDragOverRack.set(true)"
              (cdkDropListExited)="isDragOverRack.set(false)"
              style="position: relative"
            >
              @for (tile of orderedHand(); track tile.tileId) {
                @let def = tileDefsMap().get(tile.valueId!);
                @let isUsed = usedTileIds().has(tile.tileId!);

                <div
                  class="tile-wrapper"
                  cdkDrag
                  [cdkDragData]="tile.tileId"
                  [cdkDragDisabled]="isUsed"
                  (cdkDragStarted)="
                    draggingTileId.set(tile.tileId);
                    draggingTileIndex.set($index);
                    isDragOverRack.set(true)
                  "
                  (cdkDragEnded)="
                    draggingTileId.set(null); draggingTileIndex.set(null); isDragOverRack.set(false)
                  "
                >
                  <div
                    class="tile in-hand"
                    [class.is-used]="isUsed"
                    [class.selected-for-swap]="selectedTilesForSwap().has(tile.tileId)"
                    (click)="toggleTileSelection(tile.tileId)"
                  >
                    <span class="letter">{{ def?.valueText }}</span>
                    <span class="points">{{ def?.basePoints }}</span>
                  </div>

                  <div *cdkDragPlaceholder class="tile in-hand is-used">
                    <span class="letter">{{ def?.valueText }}</span>
                    <span class="points">{{ def?.basePoints }}</span>
                  </div>
                </div>
              }

              @if (draggingTileId(); as dragId) {
                @if (!isDragOverRack()) {
                  @let def = tileDefsMap().get(getTileValueIdFromHand(dragId)!);
                  <div
                    class="tile in-hand is-used ghost-persistent"
                    [style.--idx]="draggingTileIndex()"
                  >
                    <span class="letter">{{ def?.valueText }}</span>
                    <span class="points">{{ def?.basePoints }}</span>
                  </div>
                }
              }
            </div>
          </div>
        </footer>
      }
    </main>

    <div class="action-sidebar">
      <button
        class="btn-swap"
        [class.visible]="isMyTurn()"
        (click)="toggleSwapMode()"
        [class.active]="isSwapMode()"
      >
        {{ isSwapMode() ? ('lobby.cancel' | transloco) : ('lobby.swap' | transloco) }}
      </button>
      <button class="btn-skip" [class.visible]="isMyTurn()" (click)="passTurn()">
        {{ 'lobby.skip' | transloco }}
      </button>
      <button class="btn-reset" [class.visible]="isMyTurn()" (click)="resetLocalMove()">
        {{ 'lobby.reset' | transloco }}
      </button>
      <button class="btn-submit" [class.visible]="isMyTurn()" (click)="submitMove()">
        {{ 'lobby.play' | transloco }}
      </button>

      <button
        (click)="confirmSwap()"
        class="btn-confirm"
        [class.visible]="isMyTurn() && isSwapMode() && selectedTilesForSwap().size > 0"
      >
        {{ 'lobby.swap' | transloco }}({{ selectedTilesForSwap().size }})
      </button>
    </div>
  </div>
} @else {
  <app-loading-spinner />
}
